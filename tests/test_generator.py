import pytest

from src import generator
from tests.conftest import transactions_info


@pytest.mark.parametrize(
    "transactions, currency, expected",
    [
        (
            transactions_info(),
            "USD",
            [
                {
                    "date": "2018-06-30T02:08:58.425572",
                    "description": "Перевод организации",
                    "from": "Счет 75106830613657916952",
                    "id": 939719570,
                    "operationAmount": {"amount": "9824.07", "currency": {"code": "USD", "name": "USD"}},
                    "state": "EXECUTED",
                    "to": "Счет 11776614605963066702",
                },
                {
                    "date": "2019-04-04T23:20:05.206878",
                    "description": "Перевод со счета на счет",
                    "from": "Счет 19708645243227258542",
                    "id": 142264268,
                    "operationAmount": {"amount": "79114.93", "currency": {"code": "USD", "name": "USD"}},
                    "state": "EXECUTED",
                    "to": "Счет 75651667383060284188",
                },
                {
                    "date": "2018-08-19T04:27:37.904916",
                    "description": "Перевод с карты на карту",
                    "from": "Visa Classic 6831982476737658",
                    "id": 895315941,
                    "operationAmount": {"amount": "56883.54", "currency": {"code": "USD", "name": "USD"}},
                    "state": "EXECUTED",
                    "to": "Visa Platinum 8990922113665229",
                },
            ],
        ),
        (
            transactions_info(),
            "RUB",
            [
                {
                    "date": "2019-03-23T01:09:46.296404",
                    "description": "Перевод со счета на счет",
                    "from": "Счет 44812258784861134719",
                    "id": 873106923,
                    "operationAmount": {"amount": "43318.34", "currency": {"code": "RUB", "name": "руб."}},
                    "state": "EXECUTED",
                    "to": "Счет 74489636417521191160",
                },
                {
                    "date": "2018-09-12T21:27:25.241689",
                    "description": "Перевод организации",
                    "from": "Visa Platinum 1246377376343588",
                    "id": 594226727,
                    "operationAmount": {"amount": "67314.70", "currency": {"code": "RUB", "name": "руб."}},
                    "state": "CANCELED",
                    "to": "Счет 14211924144426031657",
                },
            ],
        ),
        ([], "", []),
        (
            [
                {
                    "id": 873106923,
                    "state": "EXECUTED",
                    "date": "2019-03-23T01:09:46.296404",
                    "operationAmount": {"amount": "43318.34", "currency": {"name": "руб.", "code": "RUB"}},
                    "description": "Перевод со счета на счет",
                    "from": "Счет 44812258784861134719",
                    "to": "Счет 74489636417521191160",
                },
                {
                    "id": 594226727,
                    "state": "CANCELED",
                    "date": "2018-09-12T21:27:25.241689",
                    "operationAmount": {"amount": "67314.70", "currency": {"name": "руб.", "code": "RUB"}},
                    "description": "Перевод организации",
                    "from": "Visa Platinum 1246377376343588",
                    "to": "Счет 14211924144426031657",
                },
            ],
            "USD",
            [],
        ),
    ],
)
def test_filter_by_currency_json(transactions, currency, expected):
    assert list(generator.filter_by_currency_json(transactions, currency)) == expected


def test_filter_by_currency_csvxlsx():
    assert list(
        generator.filter_by_currency_csvxlsx(
            [
                {
                    "id": 650703.0,
                    "state": "EXECUTED",
                    "date": "2023-09-05T11:30:32Z",
                    "amount": 16210.0,
                    "currency_name": "Sol",
                    "currency_code": "PEN",
                    "from": "Счет 58803664561298323391",
                    "to": "Счет 39745660563456619397",
                    "description": "Перевод организации",
                },
                {
                    "id": 3598919.0,
                    "state": "EXECUTED",
                    "date": "2020-12-06T23:00:58Z",
                    "amount": 29740.0,
                    "currency_name": "Peso",
                    "currency_code": "COP",
                    "from": "Discover 3172601889670065",
                    "to": "Discover 0720428384694643",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 593027.0,
                    "state": "CANCELED",
                    "date": "2023-07-22T05:02:01Z",
                    "amount": 30368.0,
                    "currency_name": "Shilling",
                    "currency_code": "TZS",
                    "from": "Visa 1959232722494097",
                    "to": "Visa 6804119550473710",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 366176.0,
                    "state": "EXECUTED",
                    "date": "2020-08-02T09:35:18Z",
                    "amount": 29482.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Discover 0325955596714937",
                    "to": "Visa 3820488829287420",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1962667.0,
                    "state": "EXECUTED",
                    "date": "2023-10-22T09:43:32Z",
                    "amount": 18588.0,
                    "currency_name": "Peso",
                    "currency_code": "COP",
                    "from": "Mastercard 7286844946221431",
                    "to": "Счет 76145988629288763144",
                    "description": "Перевод организации",
                },
                {
                    "id": 5294458.0,
                    "state": "EXECUTED",
                    "date": "2022-06-20T18:08:20Z",
                    "amount": 16836.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Visa 2759011965877198",
                    "to": "Счет 38287443300766991082",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3176764.0,
                    "state": "CANCELED",
                    "date": "2022-08-24T14:32:38Z",
                    "amount": 16652.0,
                    "currency_name": "Euro",
                    "currency_code": "EUR",
                    "from": "Mastercard 8387037425051294",
                    "to": "American Express 5556525473658852",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 4234093.0,
                    "state": "EXECUTED",
                    "date": "2021-07-08T07:31:21Z",
                    "amount": 23182.0,
                    "currency_name": "Ruble",
                    "currency_code": "RUB",
                    "from": "Visa 0773092093872450",
                    "to": "Discover 8602781449570491",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 2130098.0,
                    "state": "PENDING",
                    "date": "2020-06-07T11:11:36Z",
                    "amount": 30731.0,
                    "currency_name": "Euro",
                    "currency_code": "EUR",
                    "from": "Visa 5749750597771353",
                    "to": "American Express 9106381490184499",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 4653427.0,
                    "state": "PENDING",
                    "date": "2020-10-04T12:12:23Z",
                    "amount": 34072.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Discover 9058011549803523",
                    "to": "Mastercard 5266726031439012",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 4813301.0,
                    "state": "EXECUTED",
                    "date": "2021-11-02T13:32:15Z",
                    "amount": 15080.0,
                    "currency_name": "Euro",
                    "currency_code": "EUR",
                    "from": "Счет 65547878890984510340",
                    "to": "Счет 91457207307678002163",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 1449073.0,
                    "state": "CANCELED",
                    "date": "2021-05-11T10:06:51Z",
                    "amount": 11834.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Счет 17847122626293622323",
                    "to": "Счет 68570011224094542755",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 2029174.0,
                    "state": "EXECUTED",
                    "date": "2022-08-09T17:12:27Z",
                    "amount": 34143.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Visa 2717112074981212",
                    "to": "Discover 8397322380849617",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 293898.0,
                    "state": "EXECUTED",
                    "date": "2023-05-14T18:57:16Z",
                    "amount": 14031.0,
                    "currency_name": "Peso",
                    "currency_code": "PHP",
                    "from": "Visa 5962584244183755",
                    "to": "Mastercard 8961651103972237",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1849472.0,
                    "state": "EXECUTED",
                    "date": "2021-09-24T14:59:04Z",
                    "amount": 21741.0,
                    "currency_name": "Yen",
                    "currency_code": "JPY",
                    "from": "Visa 6665114452549732",
                    "to": "American Express 7292521342622607",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 2264916.0,
                    "state": "EXECUTED",
                    "date": "2020-12-04T22:59:07Z",
                    "amount": 25833.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Discover 2227841726977189",
                    "to": "Mastercard 3354646664448456",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 5371445.0,
                    "state": "PENDING",
                    "date": "2023-10-19T03:51:33Z",
                    "amount": 19556.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Discover 2269057629158313",
                    "to": "Discover 1467530652300402",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3373740.0,
                    "state": "EXECUTED",
                    "date": "2020-02-22T02:10:18Z",
                    "amount": 12439.0,
                    "currency_name": "Peso",
                    "currency_code": "MXN",
                    "from": "Discover 3471032641828884",
                    "to": "Mastercard 3506550658550576",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1527905.0,
                    "state": "CANCELED",
                    "date": "2021-01-15T05:10:15Z",
                    "amount": 19664.0,
                    "currency_name": "Hryvnia",
                    "currency_code": "UAH",
                    "from": "Visa 9812145096080028",
                    "to": "Mastercard 2052066307781062",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 5447107.0,
                    "state": "EXECUTED",
                    "date": "2021-11-01T03:49:47Z",
                    "amount": 18924.0,
                    "currency_name": "Peso",
                    "currency_code": "MXN",
                    "from": "Visa 1750234568535711",
                    "to": "Mastercard 1365460456366991",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1690784.0,
                    "state": "CANCELED",
                    "date": "2021-11-02T02:03:05Z",
                    "amount": 27487.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Mastercard 4126837433624990",
                    "to": "Visa 1620199906118385",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1838163.0,
                    "state": "EXECUTED",
                    "date": "2020-12-11T05:45:02Z",
                    "amount": 18154.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Mastercard 9557665746204580",
                    "to": "Discover 0970136905701523",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 5368178.0,
                    "state": "PENDING",
                    "date": "2020-07-07T13:57:01Z",
                    "amount": 22557.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Mastercard 4225154400758745",
                    "to": "Mastercard 0556460753444710",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1408892.0,
                    "state": "EXECUTED",
                    "date": "2020-08-15T15:35:06Z",
                    "amount": 16101.0,
                    "currency_name": "Peso",
                    "currency_code": "COP",
                    "from": "American Express 7606039262578692",
                    "to": "Счет 35266864227613549441",
                    "description": "Перевод организации",
                },
                {
                    "id": 1556435.0,
                    "state": "EXECUTED",
                    "date": "2020-06-17T02:29:13Z",
                    "amount": 27776.0,
                    "currency_name": "Sol",
                    "currency_code": "PEN",
                    "from": "Mastercard 1191143054153256",
                    "to": "Счет 48560440734108989910",
                    "description": "Перевод организации",
                },
                {
                    "id": 2832473.0,
                    "state": "EXECUTED",
                    "date": "2022-01-11T00:56:43Z",
                    "amount": 12360.0,
                    "currency_name": "Euro",
                    "currency_code": "EUR",
                    "from": "Discover 5736874734579262",
                    "to": "Visa 7416410722264963",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 448808.0,
                    "state": "EXECUTED",
                    "date": "2020-02-02T02:06:15Z",
                    "amount": 14192.0,
                    "currency_name": "Dollar",
                    "currency_code": "CAD",
                    "from": "Mastercard 8790526356570257",
                    "to": "Visa 4436252184653909",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3143449.0,
                    "state": "EXECUTED",
                    "date": "2023-08-31T11:11:51Z",
                    "amount": 32957.0,
                    "currency_name": "Real",
                    "currency_code": "BRL",
                    "from": "Visa 9446732032111774",
                    "to": "Mastercard 3661534380456235",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 2196934.0,
                    "state": "EXECUTED",
                    "date": "2022-04-05T07:17:04Z",
                    "amount": 24588.0,
                    "currency_name": "Dinar",
                    "currency_code": "TND",
                    "from": "Счет 68856226464168431377",
                    "to": "Счет 64009673148302301520",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 2051401.0,
                    "state": "PENDING",
                    "date": "2023-01-14T13:59:44Z",
                    "amount": 21616.0,
                    "currency_name": "Franc",
                    "currency_code": "XAF",
                    "from": "Discover 8023806415405011",
                    "to": "Discover 4330675064880873",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1724852.0,
                    "state": "EXECUTED",
                    "date": "2021-04-22T20:18:44Z",
                    "amount": 32530.0,
                    "currency_name": "Peso",
                    "currency_code": "COP",
                    "from": "Discover 3003758800594505",
                    "to": "Discover 3913900928954933",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3042949.0,
                    "state": "CANCELED",
                    "date": "2020-12-28T00:23:57Z",
                    "amount": 15619.0,
                    "currency_name": "Yen",
                    "currency_code": "JPY",
                    "from": "Счет 89171183136098678575",
                    "to": "Счет 37156155340203759995",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 2035682.0,
                    "state": "EXECUTED",
                    "date": "2021-03-24T00:14:15Z",
                    "amount": 15992.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Visa 9460814254923403",
                    "to": "Visa 4565912603866373",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1801202.0,
                    "state": "EXECUTED",
                    "date": "2021-08-31T20:53:22Z",
                    "amount": 31579.0,
                    "currency_name": "Peso",
                    "currency_code": "PHP",
                    "from": "Счет 75916879130750839461",
                    "to": "Счет 89355195304817814223",
                    "description": "Перевод организации",
                },
                {
                    "id": 1199673.0,
                    "state": "EXECUTED",
                    "date": "2020-10-07T08:49:52Z",
                    "amount": 25677.0,
                    "currency_name": "Peso",
                    "currency_code": "PHP",
                    "from": "American Express 9868997595486172",
                    "to": "Visa 0291209661494166",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 930103.0,
                    "state": "EXECUTED",
                    "date": "2020-11-30T08:30:48Z",
                    "amount": 12031.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Mastercard 8149574569861684",
                    "to": "Discover 1229618072674328",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1588406.0,
                    "state": "EXECUTED",
                    "date": "2021-01-01T14:58:40Z",
                    "amount": 19924.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Mastercard 4505964110651645",
                    "to": "American Express 9119180451193008",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 5134725.0,
                    "state": "CANCELED",
                    "date": "2023-11-09T13:19:45Z",
                    "amount": 16096.0,
                    "currency_name": "Quetzal",
                    "currency_code": "GTQ",
                    "from": "Счет 57742872757718903241",
                    "to": "Счет 60843316198982025818",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 4011624.0,
                    "state": "EXECUTED",
                    "date": "2023-01-10T22:13:49Z",
                    "amount": 25311.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Discover 6760437696186407",
                    "to": "Mastercard 2625117508517464",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 4739714.0,
                    "state": "CANCELED",
                    "date": "2021-03-16T09:50:38Z",
                    "amount": 29700.0,
                    "currency_name": "Baht",
                    "currency_code": "THB",
                    "from": "Discover 5448680041474638",
                    "to": "Счет 81509213611289630443",
                    "description": "Перевод организации",
                },
                {
                    "id": 1458490.0,
                    "state": "CANCELED",
                    "date": "2022-07-27T14:48:56Z",
                    "amount": 12715.0,
                    "currency_name": "Rupiah",
                    "currency_code": "IDR",
                    "from": "Mastercard 7898353316523010",
                    "to": "Discover 7865481033896023",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 4115243.0,
                    "state": "EXECUTED",
                    "date": "2020-10-02T00:58:23Z",
                    "amount": 33795.0,
                    "currency_name": "Ariary",
                    "currency_code": "MGA",
                    "from": "Mastercard 4128552733966298",
                    "to": "Visa 3778726670159351",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3231212.0,
                    "state": "EXECUTED",
                    "date": "2021-12-07T14:29:02Z",
                    "amount": 25077.0,
                    "currency_name": "Real",
                    "currency_code": "BRL",
                    "from": "Mastercard 7071811090567326",
                    "to": "Visa 3745592687709450",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 1781876.0,
                    "state": "PENDING",
                    "date": "2023-02-20T11:08:40Z",
                    "amount": 24586.0,
                    "currency_name": "Franc",
                    "currency_code": "XAF",
                    "from": "American Express 4188660988695878",
                    "to": "American Express 4670165143133955",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 3422007.0,
                    "state": "EXECUTED",
                    "date": "2022-02-16T00:17:31Z",
                    "amount": 14786.0,
                    "currency_name": "Peso",
                    "currency_code": "PHP",
                    "from": "Счет 85848394284577523191",
                    "to": "Счет 40992043018007723745",
                    "description": "Перевод организации",
                },
                {
                    "id": 2833087.0,
                    "state": "EXECUTED",
                    "date": "2022-09-02T21:13:15Z",
                    "amount": 28421.0,
                    "currency_name": "Hryvnia",
                    "currency_code": "UAH",
                    "from": "Счет 93938816885471635309",
                    "to": "Счет 27679999248091965215",
                    "description": "Перевод со счета на счет",
                },
                {
                    "id": 3211835.0,
                    "state": "CANCELED",
                    "date": "2020-07-03T13:56:11Z",
                    "amount": 30035.0,
                    "currency_name": "Rial",
                    "currency_code": "QAR",
                    "from": "Visa 8001999082783412",
                    "to": "Mastercard 0430116126947445",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 2627887.0,
                    "state": "CANCELED",
                    "date": "2020-01-03T17:08:51Z",
                    "amount": 18001.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "Mastercard 8757974222871146",
                    "to": "Discover 7955094807047223",
                    "description": "Перевод с карты на карту",
                },
                {
                    "id": 632926.0,
                    "state": "PENDING",
                    "date": "2021-11-27T00:46:09Z",
                    "amount": 29553.0,
                    "currency_name": "Yuan Renminbi",
                    "currency_code": "CNY",
                    "from": "American Express 6477627838877562",
                    "to": "Счет 88381741644903346269",
                    "description": "Перевод организации",
                },
            ],
            "RUB",
        )
    ) == [
        {
            "id": 4234093.0,
            "state": "EXECUTED",
            "date": "2021-07-08T07:31:21Z",
            "amount": 23182.0,
            "currency_name": "Ruble",
            "currency_code": "RUB",
            "from": "Visa 0773092093872450",
            "to": "Discover 8602781449570491",
            "description": "Перевод с карты на карту",
        }
    ]


def test_transaction_descriptions():
    assert list(generator.transaction_descriptions(transactions_info())) == [
        "Перевод организации",
        "Перевод со счета на счет",
        "Перевод со счета на счет",
        "Перевод с карты на карту",
        "Перевод организации",
    ]
    assert list(
        generator.transaction_descriptions(
            [
                {
                    "id": 939719570,
                    "state": "EXECUTED",
                    "date": "2018-06-30T02:08:58.425572",
                    "operationAmount": {"amount": "9824.07", "currency": {"name": "USD", "code": "USD"}},
                    "description": "Перевод организации",
                    "from": "Счет 75106830613657916952",
                    "to": "Счет 11776614605963066702",
                },
                {
                    "id": 142264268,
                    "state": "EXECUTED",
                    "date": "2019-04-04T23:20:05.206878",
                    "operationAmount": {"amount": "79114.93", "currency": {"name": "USD", "code": "USD"}},
                    "description": "Перевод со счета на счет",
                    "from": "Счет 19708645243227258542",
                    "to": "Счет 75651667383060284188",
                },
                {
                    "id": 873106923,
                    "state": "EXECUTED",
                    "date": "2019-03-23T01:09:46.296404",
                    "operationAmount": {"amount": "43318.34", "currency": {"name": "руб.", "code": "RUB"}},
                    "description": "Перевод со счета на счет",
                    "from": "Счет 44812258784861134719",
                    "to": "Счет 74489636417521191160",
                },
                {
                    "id": 895315941,
                    "state": "EXECUTED",
                    "date": "2018-08-19T04:27:37.904916",
                    "operationAmount": {"amount": "56883.54", "currency": {"name": "USD", "code": "USD"}},
                    "description": "Перевод с карты на карту",
                    "from": "Visa Classic 6831982476737658",
                    "to": "Visa Platinum 8990922113665229",
                },
                {
                    "id": 594226727,
                    "state": "CANCELED",
                    "date": "2018-09-12T21:27:25.241689",
                    "operationAmount": {"amount": "67314.70", "currency": {"name": "руб.", "code": "RUB"}},
                    "from": "Visa Platinum 1246377376343588",
                    "to": "Счет 14211924144426031657",
                },
            ]
        )
    ) == ["Перевод организации", "Перевод со счета на счет", "Перевод со счета на счет", "Перевод с карты на карту"]
    assert list(generator.transaction_descriptions([])) == []


def test_card_number_generator():
    assert list(generator.card_number_generator(1, 5)) == [
        "0000 0000 0000 0001",
        "0000 0000 0000 0002",
        "0000 0000 0000 0003",
        "0000 0000 0000 0004",
        "0000 0000 0000 0005",
    ]
    assert list(generator.card_number_generator(1, 1)) == ["0000 0000 0000 0001"]
    with pytest.raises(ValueError):
        assert list(generator.card_number_generator(-1, 5)) == ValueError
    with pytest.raises(ValueError):
        assert list(generator.card_number_generator(1, 10000000000000000)) == ValueError
